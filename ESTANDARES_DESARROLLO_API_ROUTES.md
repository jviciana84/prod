# üìê EST√ÅNDARES DE DESARROLLO - API ROUTES

**Fecha:** 19 de Octubre de 2025  
**Versi√≥n:** 1.0  
**Obligatorio:** S√ç - Para TODO c√≥digo nuevo

---

## üéØ REGLA DE ORO

**‚ùå NUNCA M√ÅS:**
```typescript
// ‚ùå PROHIBIDO: Cliente directo para consultas iniciales
const supabase = createClientComponentClient()

useEffect(() => {
  const loadData = async () => {
    const { data } = await supabase.from("table").select("*")
    setData(data)
  }
  loadData()
}, [])
```

**‚úÖ SIEMPRE:**
```typescript
// ‚úÖ CORRECTO: API Route + fetch
useEffect(() => {
  const loadData = async () => {
    const response = await fetch("/api/table/list")
    const { data } = await response.json()
    setData(data)
  }
  loadData()
}, [])
```

---

## üìã PATR√ìN OBLIGATORIO

### 1Ô∏è‚É£ Backend: API Route

**Ubicaci√≥n:** `app/api/[recurso]/[accion]/route.ts`

**Plantilla:**
```typescript
// app/api/mi-tabla/list/route.ts
import { createServerClient } from "@/lib/supabase/server"
import { cookies } from "next/headers"
import { NextResponse } from "next/server"

export async function GET() {
  try {
    const supabase = await createServerClient(await cookies())

    // Verificar autenticaci√≥n
    const { data: { user }, error: userError } = await supabase.auth.getUser()
    if (userError || !user) {
      return NextResponse.json({ error: "No autorizado" }, { status: 401 })
    }

    // Consulta de datos
    const { data, error } = await supabase
      .from("mi_tabla")
      .select("*")
      .order("created_at", { ascending: false })

    if (error) {
      console.error("Error en consulta:", error)
      return NextResponse.json({ error: error.message }, { status: 500 })
    }

    return NextResponse.json({
      data: data || [],
    })
  } catch (error) {
    console.error("Error inesperado:", error)
    return NextResponse.json({ error: "Error interno del servidor" }, { status: 500 })
  }
}
```

---

### 2Ô∏è‚É£ Frontend: Componente

**Plantilla:**
```typescript
"use client"

import { useState, useEffect } from "react"
import { toast } from "sonner"

export default function MiComponente() {
  const [data, setData] = useState([])
  const [loading, setLoading] = useState(false)

  // Cliente Supabase SOLO para mutaciones (opcional)
  // const supabase = createClientComponentClient()

  useEffect(() => {
    loadData()
  }, [])

  const loadData = async () => {
    setLoading(true)
    try {
      console.log("üîç Cargando datos desde API...")
      const response = await fetch("/api/mi-tabla/list")

      if (!response.ok) {
        throw new Error("Error al cargar datos")
      }

      const { data } = await response.json()
      setData(data || [])
      console.log("‚úÖ Datos cargados:", data?.length || 0)
    } catch (error) {
      console.error("‚ùå Error:", error)
      toast.error("Error al cargar los datos")
    } finally {
      setLoading(false)
    }
  }

  // Mutaciones (si necesario)
  const handleUpdate = async (id: string, newData: any) => {
    const supabase = createClientComponentClient()
    const { error } = await supabase
      .from("mi_tabla")
      .update(newData)
      .eq("id", id)

    if (error) {
      toast.error("Error al actualizar")
      return
    }

    toast.success("Actualizado correctamente")
    loadData() // Recargar desde API
  }

  return (
    <div>
      {loading ? <p>Cargando...</p> : <Table data={data} />}
    </div>
  )
}
```

---

## üö´ ANTI-PATRONES (NO HACER)

### ‚ùå 0. Datos falsos/mock/ejemplo
```typescript
// ‚ùå PROHIBIDO: Datos falsos
const mockData = [{ id: "1", name: "Fake" }]
const usarDatosEjemplo = () => { ... }
const fallbackData = [...]

// ‚úÖ CORRECTO: Array vac√≠o + error claro
if (error) {
  setPedidos([])
  toast.error("Error al cargar. Contacta soporte.")
}
```

### ‚ùå 1. Cliente directo en useEffect
```typescript
// ‚ùå PROHIBIDO
const supabase = createClientComponentClient()
useEffect(() => {
  supabase.from("table").select("*").then(...)
}, [])
```

### ‚ùå 2. Cliente en useRef
```typescript
// ‚ùå PROHIBIDO
const supabaseRef = useRef(createClientComponentClient())
useEffect(() => {
  supabaseRef.current.from("table").select("*").then(...)
}, [])
```

### ‚ùå 3. Consulta directa en componente server
```typescript
// ‚ùå PROHIBIDO (usar API Route)
export default async function ServerComponent() {
  const supabase = await createServerClient()
  const { data } = await supabase.from("table").select("*")
  return <div>{data}</div>
}
```
**Excepci√≥n:** Solo permitido en Layout o p√°gina principal de Dashboard.

---

## ‚úÖ CASOS DE USO

### Caso 1: Tabla con datos

**Necesitas:** Mostrar lista de items

**Soluci√≥n:**
1. Crear `/api/items/list/route.ts`
2. Component hace `fetch("/api/items/list")`

---

### Caso 2: Formulario que crea datos

**Necesitas:** POST para crear item

**Soluci√≥n:**
1. Crear `/api/items/create/route.ts` (POST)
2. Component hace `fetch("/api/items/create", { method: "POST", body: ... })`

**Alternativa:** Usar cliente directo para mutaciones simples (INSERT)
```typescript
const supabase = createClientComponentClient()
const { error } = await supabase.from("items").insert(newData)
```

---

### Caso 3: Edici√≥n de item

**Necesitas:** UPDATE de datos

**Soluci√≥n:**
```typescript
// Opci√≥n A: API Route
POST /api/items/update
Body: { id, data }

// Opci√≥n B: Cliente directo (m√°s simple)
const supabase = createClientComponentClient()
await supabase.from("items").update(data).eq("id", id)
```

**Recomendaci√≥n:** Cliente directo para mutaciones simples (m√°s r√°pido).

---

### Caso 4: Filtros complejos

**Necesitas:** B√∫squeda con filtros

**Soluci√≥n:**
```typescript
// API Route con par√°metros
POST /api/items/list
Body: { search, filters, page, limit }

// Component
const response = await fetch("/api/items/list", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ search, filters, page, limit }),
})
```

---

## üìù CHECKLIST ANTES DE COMMIT

### Para TODO c√≥digo nuevo:

- [ ] ¬øLa consulta inicial usa API Route? (‚úÖ S√≠ / ‚ùå No)
- [ ] ¬øHay logs de tracking? (üîç Cargando... / ‚úÖ Cargado)
- [ ] ¬øHay manejo de errores? (try-catch + toast)
- [ ] ¬øVerificas autenticaci√≥n en API Route?
- [ ] ¬øEl cliente Supabase solo se usa para mutaciones?
- [ ] ¬øHay loading state?
- [ ] ¬øProbaste que funciona sin F5?

---

## üîç CODE REVIEW CHECKLIST

### Al revisar Pull Request:

```markdown
### Checklist API Routes

- [ ] **Sin cliente directo en consultas iniciales**
  - ‚ùå Encontrado: `useEffect(() => supabase.from(...)`
  - ‚úÖ Correcto: `useEffect(() => fetch("/api/...")`

- [ ] **API Route creada si necesaria**
  - Ubicaci√≥n: `app/api/[recurso]/[accion]/route.ts`
  - Autenticaci√≥n verificada: ‚úÖ
  - Manejo de errores: ‚úÖ

- [ ] **Logs de tracking**
  - üîç Log inicio: ‚úÖ
  - ‚úÖ Log √©xito: ‚úÖ
  - ‚ùå Log error: ‚úÖ

- [ ] **Manejo de errores**
  - try-catch: ‚úÖ
  - toast.error(): ‚úÖ
  - Estado de loading: ‚úÖ

- [ ] **Cliente solo para mutaciones**
  - INSERT/UPDATE/DELETE: ‚úÖ (permitido)
  - SELECT inicial: ‚ùå (usar API Route)
```

---

## üìö EJEMPLOS REALES DEL PROYECTO

### ‚úÖ Ejemplo 1: Ventas (Completo)

**API Route:** `app/api/sales/list/route.ts`
```typescript
export async function GET() {
  const supabase = await createServerClient(await cookies())
  const { data } = await supabase.from("sales_vehicles").select("*")
  return NextResponse.json({ data })
}
```

**Component:** `components/sales/sales-table.tsx`
```typescript
const loadSoldVehicles = async () => {
  console.log("üîÑ Cargando desde API...")
  const response = await fetch("/api/sales/list")
  const { data } = await response.json()
  console.log("‚úÖ Cargados:", data.length)
  setVehicles(data)
}
```

---

### ‚úÖ Ejemplo 2: Noticias (Simple)

**API Route:** `app/api/noticias/list/route.ts`
```typescript
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const limit = searchParams.get("limit") ? parseInt(searchParams.get("limit")!) : undefined

  const query = supabase.from("noticias").select("*")
  if (limit) query.limit(limit)
  
  const { data } = await query
  return NextResponse.json({ data })
}
```

**Component:** `components/dashboard/news-dropdown.tsx`
```typescript
const fetchNoticias = async () => {
  const response = await fetch("/api/noticias/list?limit=5")
  const { data } = await response.json()
  setNoticias(data)
}
```

---

### ‚úÖ Ejemplo 3: Conversaciones (Filtros)

**API Route:** `app/api/conversations/list/route.ts`
```typescript
export async function POST(request: Request) {
  const body = await request.json()
  const { page, itemsPerPage, sessionId, userId, searchTerm } = body

  let query = supabase.from("conversations").select("*", { count: "exact" })
  
  if (sessionId !== "all") query = query.eq("session_id", sessionId)
  if (userId !== "all") query = query.eq("user_id", userId)
  if (searchTerm) query = query.ilike("message", `%${searchTerm}%`)
  
  query = query.range((page - 1) * itemsPerPage, page * itemsPerPage - 1)
  
  const { data, count } = await query
  return NextResponse.json({ data, count })
}
```

---

## üéì TRAINING: MIGRAR C√ìDIGO LEGACY

### Si encuentras c√≥digo antiguo:

```typescript
// ‚ùå C√ìDIGO ANTIGUO (legacy)
const supabase = createClientComponentClient()

useEffect(() => {
  const loadData = async () => {
    const { data } = await supabase.from("old_table").select("*")
    setData(data)
  }
  loadData()
}, [])
```

### Proceso de migraci√≥n:

**Paso 1:** Crear API Route
```bash
# Crear archivo
mkdir -p app/api/old-table/list
touch app/api/old-table/list/route.ts
```

**Paso 2:** Implementar API Route
```typescript
// app/api/old-table/list/route.ts
import { createServerClient } from "@/lib/supabase/server"
import { cookies } from "next/headers"
import { NextResponse } from "next/server"

export async function GET() {
  const supabase = await createServerClient(await cookies())
  const { data } = await supabase.from("old_table").select("*")
  return NextResponse.json({ data })
}
```

**Paso 3:** Refactorizar componente
```typescript
// ‚úÖ C√ìDIGO NUEVO (migrado)
useEffect(() => {
  const loadData = async () => {
    console.log("üîç Cargando desde API...")
    const response = await fetch("/api/old-table/list")
    const { data } = await response.json()
    setData(data)
    console.log("‚úÖ Cargado:", data.length)
  }
  loadData()
}, [])
```

**Paso 4:** Probar
```bash
npm run dev
# Verificar en consola: üîç Cargando... ‚Üí ‚úÖ Cargado
```

---

## üöÄ WORKFLOW PARA NUEVA FEATURE

### 1. Planificaci√≥n
```markdown
Feature: [Nombre de la feature]

Datos necesarios:
- Tabla 1: [nombre]
- Tabla 2: [nombre]

API Routes a crear:
- GET /api/feature/list
- POST /api/feature/create (opcional)
- POST /api/feature/update (opcional)
```

### 2. Implementaci√≥n

**Orden recomendado:**
1. ‚úÖ Crear API Routes
2. ‚úÖ Probar API Routes en Postman/Thunder Client
3. ‚úÖ Crear componente frontend
4. ‚úÖ Integrar con API Routes
5. ‚úÖ Probar en local
6. ‚úÖ Code review
7. ‚úÖ Push a staging
8. ‚úÖ Testing en staging
9. ‚úÖ Deploy a producci√≥n

### 3. Testing

**Checklist:**
- [ ] Datos cargan correctamente
- [ ] No hay loading infinito
- [ ] Consola sin errores rojos
- [ ] Navegaci√≥n fluida
- [ ] F5 no es necesario
- [ ] Funciona en inc√≥gnito

---

## üìä M√âTRICAS DE CALIDAD

### KPIs del nuevo c√≥digo:

| M√©trica | Objetivo |
|---------|----------|
| **API Routes para consultas iniciales** | 100% |
| **Logs de tracking** | 100% |
| **Manejo de errores** | 100% |
| **Loading infinito** | 0% |
| **Errores en consola** | 0 |
| **F5 necesario** | 0% |

---

## üéØ RESUMEN EJECUTIVO

### Para desarrolladores nuevos:

**3 Reglas Simples:**

1. **Consultas iniciales** ‚Üí API Route + fetch
2. **Mutaciones simples** ‚Üí Cliente directo (opcional)
3. **Siempre logs** ‚Üí üîç Cargando... / ‚úÖ Cargado

**Plantillas listas:**
- `app/api/[recurso]/list/route.ts` (backend)
- Componente con fetch (frontend)

**Ejemplos reales:**
- Ver `app/api/sales/list/route.ts`
- Ver `components/sales/sales-table.tsx`

---

## üÜò SOPORTE

### Si tienes dudas:

1. **Lee documentaci√≥n:**
   - `README_MIGRACION_API_ROUTES.md`
   - Este documento

2. **Busca ejemplos:**
   - 18 API Routes ya creadas
   - 14 componentes ya migrados

3. **Pregunta antes de codear:**
   - ¬øEsto necesita API Route?
   - ¬øO puedo usar cliente directo?

4. **En caso de duda:**
   - **Siempre usa API Route** (m√°s seguro)

---

**Versi√≥n:** 1.0  
**√öltima actualizaci√≥n:** 19 de Octubre de 2025  
**Mantenido por:** Equipo de desarrollo

