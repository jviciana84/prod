# üìç PASO 1: SCRAPER DUC ‚Üí TABLA duc_scraper
**An√°lisis detallado del primer paso del sistema**

---

## üéØ ¬øQU√â ES ESTO?

El scraper DUC es un **robot automatizado** que cada 8 horas:
1. Abre la p√°gina web de DUC (donde est√°n publicados los veh√≠culos)
2. Descarga un archivo CSV con todos los veh√≠culos
3. Sube ese CSV a la base de datos (tabla `duc_scraper`)

**Es como un empleado que cada 8 horas va a la web de DUC, copia todos los veh√≠culos, y los pega en una hoja de Excel en Supabase.**

---

## üìÅ ARCHIVOS INVOLUCRADOS

### 1. El Scraper (Robot)
**Ubicaci√≥n:** `cvo-scraper-v1/main.py`  
**Tipo:** Aplicaci√≥n Python con ventana (Tkinter)  
**Ejecutable:** `cvo-scraper-v1/dist/CVO_Scraper_QUADIS_Munich.exe`

### 2. CSV Descargados
**Ubicaci√≥n:** `cvo-scraper-v1/dist/data/duc/`  
**Ejemplo de archivo:**
```
stock_551_0_2025_10_21_17_47_54.csv
stock_551_0_2025_10_21_17_22_31.csv
stock_551_0_2025_10_21_17_07_26.csv
```

**Formato del nombre:**
- `stock_551_0` = Identificador del concesionario
- `2025_10_21` = Fecha (a√±o_mes_d√≠a)
- `17_47_54` = Hora (hora_minuto_segundo)

### 3. Tabla en Supabase
**Tabla:** `duc_scraper`  
**Tipo:** Tabla de staging (datos brutos)

---

## ü§ñ ¬øC√ìMO FUNCIONA EL SCRAPER?

### Configuraci√≥n Actual (main.py)

```python
# Credenciales DUC
duc_username = "Jordivi01"
duc_password = "Jordivi02"

# Programaci√≥n
duc_schedule_enabled = True
duc_start_time = "09:00"
duc_end_time = "18:00"
duc_interval_hours = 8  # Cada 8 horas
duc_days = "L,M,X,J,V,S,D"  # Todos los d√≠as
```

**Horario de ejecuci√≥n:**
- Primera ejecuci√≥n: 09:00
- Segunda ejecuci√≥n: 17:00 (09:00 + 8h)
- Luego vuelve al d√≠a siguiente a las 09:00

---

## üîÑ PROCESO COMPLETO PASO A PASO

### Fase 1: Conexi√≥n y Login (Selenium)

```python
# 1. Abrir Chrome en modo headless (sin ventana)
driver = webdriver.Chrome(options=chrome_options)

# 2. Ir a la p√°gina de login
driver.get('https://gestionbmw.motorflash.com/login.php')

# 3. Rellenar formulario
username_field.send_keys("Jordivi01")
password_field.send_keys("Jordivi02")
login_button.click()

# 4. Esperar a que cargue (URL cambia)
# Antes: /login.php
# Despu√©s: /index.php o /dashboard.php
```

**Tiempo estimado:** ~5 segundos

---

### Fase 2: Descarga del CSV

```python
# 5. Click en bot√≥n "Crear Excel"
crear_excel_btn.click()
time.sleep(2)

# 6. Click en "Generar fichero"
generar_btn.click()
time.sleep(3)

# 7. Click en "Descargar fichero"
descargar_link.click()
time.sleep(10)  # Esperar descarga

# 8. CSV se guarda en: dist/data/duc/
```

**Resultado:**
```
üìÅ dist/data/duc/
  ‚îú‚îÄ stock_551_0_2025_10_21_17_47_54.csv  ‚Üê NUEVO
  ‚îú‚îÄ stock_551_0_2025_10_21_17_22_31.csv
  ‚îî‚îÄ stock_551_0_2025_10_21_17_07_26.csv
```

**Tiempo estimado:** ~15 segundos

---

### Fase 3: Lectura del CSV

```python
# 9. Buscar el CSV m√°s reciente
csv_files = glob.glob("dist/data/duc/*.csv")
latest_file = max(csv_files, key=os.path.getctime)

# 10. Leer CSV con pandas
df = pd.read_csv(
    latest_file,
    sep=';',           # Separador: punto y coma
    encoding='utf-8',  # Codificaci√≥n
    quotechar='"'      # Comillas para textos
)
```

**Contenido del CSV (ejemplo):**
```csv
ID Anuncio;Matr√≠cula;Modelo;Disponibilidad;Precio;Kil√≥metros;...
12345;1234ABC;BMW 320d;DISPONIBLE;25000;50000;...
12346;5678DEF;BMW X3;RESERVADO;35000;30000;...
12347;9012GHI;MINI Cooper;DISPONIBLE;18000;40000;...
```

**Total de columnas:** ~100 columnas  
**Columnas √∫tiles:** ~89 columnas tienen datos

---

### Fase 4: Limpieza de Datos

```python
# 11. Limpiar nombres de columnas
df.columns = df.columns.str.strip()           # Quitar espacios
df.columns = df.columns.str.replace('\t', ' ') # Quitar tabuladores
df.columns = df.columns.str.replace('  ', ' ') # Espacios dobles

# 12. MAPEO ESPECIAL: Acento en "R√©gimen"
df.rename(columns={
    'R√©gimen fiscal': 'Regimen fiscal'  # CSV con acento ‚Üí DB sin acento
}, inplace=True)
```

**Problema resuelto:**
- CSV viene con: `R√©gimen fiscal` (con acento)
- Supabase espera: `Regimen fiscal` (sin acento)
- Si no se mapea, falla la inserci√≥n

---

### Fase 5: Conversi√≥n a Diccionarios

```python
# 13. Convertir cada fila a un diccionario
cleaned_records = []
for index, row in df.iterrows():
    record = {}
    for col in df.columns:
        value = row[col]
        
        # Manejo de valores especiales
        if pd.isna(value):
            record[col] = None  # NULL
        elif isinstance(value, datetime):
            record[col] = value.strftime('%Y-%m-%d %H:%M:%S')
        elif isinstance(value, (int, float)):
            record[col] = value
        else:
            record[col] = str(value)  # Texto
    
    cleaned_records.append(record)
```

**Ejemplo de un record (simplificado):**
```python
{
    "ID Anuncio": "12345",
    "Matr√≠cula": "1234ABC",
    "Modelo": "BMW 320d",
    "Disponibilidad": "DISPONIBLE",
    "Precio": 25000.00,
    "Kil√≥metros": 50000,
    "Combustible": "Diesel",
    "Fecha matriculaci√≥n": "2020-05-15",
    "Color": "Negro",
    "Transmisi√≥n": "Autom√°tica",
    # ... + 80 campos m√°s
    "file_name": "stock_551_0_2025_10_21_17_47_54.csv",
    "import_date": "2025-10-21 17:47:54",
    "last_seen_date": "2025-10-21 17:47:54"
}
```

**Total de records:** 79 veh√≠culos ‚úÖ (ACTUAL)

---

## üíæ SUBIDA A SUPABASE

### Fase 6: Conexi√≥n a Supabase

```python
# 14. Conectar con Supabase
supabase = create_client(
    "https://wpjmimbscfsdzcwuwctk.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."  # Service Role Key
)
```

---

### Fase 7: BORRADO COMPLETO (‚ö†Ô∏è IMPORTANTE)

```python
# 15. ELIMINAR TODOS los registros anteriores
supabase.table('duc_scraper').delete().gt("created_at", "1900-01-01").execute()
# Resultado: duc_scraper queda vac√≠o
```

**‚ö†Ô∏è ESTO ES CR√çTICO:**
- Se borran TODOS los registros de `duc_scraper`
- No se conserva historial
- Es un "borr√≥n y cuenta nueva" cada 8 horas

**Raz√≥n:**
- Para evitar duplicados
- Para mantener solo los veh√≠culos actuales de DUC
- Para no acumular veh√≠culos antiguos

**Ejemplo:**
```
ANTES (09:00):
duc_scraper tiene 79 veh√≠culos

SCRAPER ejecuta (17:00):
1. DELETE ‚Üí duc_scraper queda vac√≠o (0 veh√≠culos)
2. INSERT ‚Üí duc_scraper tiene 79 veh√≠culos nuevos

DESPU√âS (17:00):
duc_scraper tiene 79 veh√≠culos ‚úÖ (datos frescos HOY)
```

---

### Fase 8: INSERCI√ìN MASIVA

```python
# 16. Insertar los 79 registros ‚úÖ (ACTUAL)
result = supabase.table('duc_scraper').insert(cleaned_records).execute()
```

**Lo que hace internamente (SQL):**
```sql
INSERT INTO duc_scraper (
    "ID Anuncio",
    "Matr√≠cula",
    "Modelo",
    "Disponibilidad",
    "Precio",
    -- ... + 85 columnas m√°s
    "file_name",
    "import_date",
    "last_seen_date"
) VALUES
    ('12345', '1234ABC', 'BMW 320d', 'DISPONIBLE', 25000, ..., 'stock_551...csv', '2025-10-21 17:47:54', '2025-10-21 17:47:54'),
    ('12346', '5678DEF', 'BMW X3', 'RESERVADO', 35000, ..., 'stock_551...csv', '2025-10-21 17:47:54', '2025-10-21 17:47:54'),
    ('12347', '9012GHI', 'MINI Cooper', 'DISPONIBLE', 18000, ..., 'stock_551...csv', '2025-10-21 17:47:54', '2025-10-21 17:47:54'),
    -- ... x79 filas ‚úÖ (ACTUAL)
```

**Tiempo estimado:** ~2-3 segundos para 79 registros

---

## üìä ESTRUCTURA DE LA TABLA duc_scraper

### Columnas Principales

```sql
CREATE TABLE duc_scraper (
    -- COLUMNAS DEL CSV (89 con datos reales)
    "ID Anuncio" VARCHAR PRIMARY KEY,
    "Matr√≠cula" VARCHAR,
    "Modelo" VARCHAR,
    "Disponibilidad" VARCHAR,  ‚Üê CLAVE: "DISPONIBLE" | "RESERVADO" | "VENDIDO"
    "Precio" DECIMAL,
    "Kil√≥metros" INTEGER,
    "Combustible" VARCHAR,
    "Transmisi√≥n" VARCHAR,
    "Color" VARCHAR,
    "Fecha matriculaci√≥n" DATE,
    "Marca" VARCHAR,
    "Versi√≥n" VARCHAR,
    "Potencia CV" INTEGER,
    "Equipamiento" TEXT,
    -- ... + 75 columnas m√°s
    
    -- COLUMNAS A√ëADIDAS POR EL SCRAPER
    "file_name" VARCHAR,           -- Nombre del CSV de origen
    "import_date" TIMESTAMP,       -- Cu√°ndo se import√≥
    "last_seen_date" TIMESTAMP,    -- √öltima vez visto
    "created_at" TIMESTAMP DEFAULT NOW()
)
```

---

## üìà EJEMPLO REAL DE DATOS

### Registro Completo (Ejemplo)

```json
{
    "ID Anuncio": "548796",
    "Matr√≠cula": "2382MPL",
    "Modelo": "BMW Serie 3 320d",
    "Disponibilidad": "RESERVADO",
    "Precio": 24900.00,
    "Kil√≥metros": 45000,
    "Combustible": "Diesel",
    "Transmisi√≥n": "Autom√°tica",
    "Color": "Negro Zafiro Metalizado",
    "Fecha matriculaci√≥n": "2020-06-15",
    "Marca": "BMW",
    "Versi√≥n": "320d xDrive",
    "Potencia CV": 190,
    "Carrocer√≠a": "Berlina",
    "Puertas": 4,
    "Plazas": 5,
    "Garant√≠a": "24 meses",
    "IVA deducible": "S√≠",
    "Estado": "Seminuevo",
    "D√≠as stock": 45,
    "Equipamiento": "Navegador, Sensores aparcamiento, C√°mara trasera...",
    
    "file_name": "stock_551_0_2025_10_21_17_47_54.csv",
    "import_date": "2025-10-21T17:47:54.000Z",
    "last_seen_date": "2025-10-21T17:47:54.000Z",
    "created_at": "2025-10-21T17:47:54.000Z"
}
```

---

## üìä ESTAD√çSTICAS ACTUALES

### Datos del √∫ltimo scraping (21 Oct 2025) - ‚ö†Ô∏è ACTUALIZADOS

```
Total de veh√≠culos en duc_scraper: 79 ‚úÖ (DATO REAL ACTUAL)

Por disponibilidad:
‚îú‚îÄ DISPONIBLE: ~68 veh√≠culos (86%)
‚îú‚îÄ RESERVADO: ~10 veh√≠culos (13%)
‚îî‚îÄ VENDIDO: ~1 veh√≠culo (1%)

Por marca:
‚îú‚îÄ BMW: ~48 veh√≠culos
‚îú‚îÄ MINI: ~26 veh√≠culos
‚îî‚îÄ Otros: ~5 veh√≠culos

Columnas con datos: 89/100
Columnas vac√≠as: 11
```

---

## ‚ö†Ô∏è PROBLEMA CR√çTICO: TABLA AISLADA

### El Gran Problema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   üìä duc_scraper                       ‚îÇ
‚îÇ   79 veh√≠culos ‚úÖ (ACTUAL)             ‚îÇ
‚îÇ   ~10 RESERVADOS                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚Üì ‚ùå NO HAY CONEXI√ìN
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   üìä stock                             ‚îÇ
‚îÇ   168 veh√≠culos                        ‚îÇ
‚îÇ   is_sold = FALSE para esos ~10       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Lo que pasa:**
1. Scraper encuentra veh√≠culo con `Disponibilidad = "RESERVADO"`
2. Lo guarda en `duc_scraper` correctamente ‚úÖ
3. **PERO** no actualiza `stock.is_sold = true` ‚ùå
4. Resultado: Veh√≠culo RESERVADO en DUC aparece DISPONIBLE en el sistema CVO

**Ejemplo concreto:**
```sql
-- En duc_scraper (datos del scraper)
{
    "Matr√≠cula": "2382MPL",
    "Disponibilidad": "RESERVADO"  ‚Üê Correcto en DUC
}

-- En stock (tabla operacional)
{
    license_plate: "2382MPL",
    is_sold: FALSE  ‚Üê INCORRECTO: deber√≠a ser TRUE
}
```

**Impacto:**
- Usuarios ven veh√≠culos disponibles que ya est√°n reservados
- Se puede intentar vender un veh√≠culo ya vendido
- Datos inconsistentes entre DUC y CVO

---

## üîß ¬øQU√â FALTA PARA COMPLETAR ESTE PASO?

### Soluci√≥n Necesaria: TRIGGER o SCRIPT

**Opci√≥n 1: Trigger de base de datos**
```sql
CREATE FUNCTION sync_duc_to_stock()
RETURNS TRIGGER AS $$
BEGIN
    -- Si un veh√≠culo est√° RESERVADO en duc_scraper
    IF NEW."Disponibilidad" ILIKE '%RESERVADO%' THEN
        -- Actualizar stock
        UPDATE stock 
        SET is_sold = TRUE 
        WHERE license_plate = NEW."Matr√≠cula";
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_sync_duc_to_stock
    AFTER INSERT OR UPDATE ON duc_scraper
    FOR EACH ROW
    EXECUTE FUNCTION sync_duc_to_stock();
```

**Opci√≥n 2: Script manual (cada 8 horas)**
```javascript
// scripts/sync_duc_to_stock.js
async function syncDucToStock() {
    // 1. Obtener RESERVADOS de duc_scraper
    const { data: reservados } = await supabase
        .from('duc_scraper')
        .select('Matr√≠cula')
        .eq('Disponibilidad', 'RESERVADO')
    
    // 2. Actualizar stock
    for (const vehiculo of reservados) {
        await supabase
            .from('stock')
            .update({ is_sold: true })
            .eq('license_plate', vehiculo.Matr√≠cula)
    }
}
```

---

## üìã LOGS DEL SCRAPER

### Ejemplo de log real (scraper.log)

```
[17:47:30] üöÄ CVO Scraper V1 iniciado
[17:47:32] üîÑ Iniciando scrapers autom√°ticamente...
[17:47:32] üöÄ Ejecutando DUC (autom√°tico)...
[17:47:33] üöó Iniciando descarga CSV de DUC...
[17:47:33] üìÅ Carpeta: dist/data/duc
[17:47:34] üîë Intentando login con usuario: Jordivi01
[17:47:39] ‚úÖ Login exitoso - URL: https://gestionbmw.motorflash.com/index.php
[17:47:41] ‚úÖ Click en 'Crear Excel'
[17:47:43] ‚úÖ Click en 'Generar fichero'
[17:47:46] ‚úÖ Descarga iniciada
[17:47:56] üìÑ Archivo: stock_551_0_2025_10_21_17_47_54.csv
[17:47:57] üìä CSV le√≠do con encoding utf-8: 79 registros ‚úÖ (ACTUAL)
[17:47:57] üìã Columnas del CSV: 100 columnas encontradas
[17:47:57] üìã Registros procesados: 79 ‚úÖ
[17:47:58] ‚úÖ Supabase configurado
[17:48:02] ‚úÖ Datos subidos a Supabase: 79 registros ‚úÖ (HOY)
[17:48:02] ‚úÖ DUC completado exitosamente
```

---

## üéØ RESUMEN DEL PASO 1

### ‚úÖ Lo que funciona BIEN

1. **Conexi√≥n autom√°tica:** Scraper se ejecuta solo cada 8 horas ‚úÖ
2. **Login autom√°tico:** Credenciales funcionan ‚úÖ
3. **Descarga CSV:** Selenium funciona perfectamente ‚úÖ
4. **Procesamiento:** CSV se lee y limpia correctamente ‚úÖ
5. **Subida a Supabase:** 140 registros se insertan sin errores ‚úÖ
6. **Datos completos:** 89 columnas con informaci√≥n √∫til ‚úÖ

### ‚ùå Lo que NO funciona

1. **Tabla aislada:** duc_scraper no alimenta a stock ‚ùå
2. **Sin sincronizaci√≥n:** RESERVADOS no marcan is_sold ‚ùå
3. **Sin historial:** Se borra todo cada 8 horas ‚ùå

### üìä Estado actual

```
DATOS EN DUC (Web externa):
‚îî‚îÄ 79 veh√≠culos publicados ‚úÖ (ACTUAL)

DATOS EN duc_scraper (CVO):
‚îî‚îÄ 79 veh√≠culos (actualizado cada 8h) ‚úÖ (ACTUAL)
   ‚îú‚îÄ ~68 DISPONIBLES
   ‚îú‚îÄ ~10 RESERVADOS
   ‚îî‚îÄ ~1 VENDIDO

DATOS EN stock (CVO):
‚îî‚îÄ 168 veh√≠culos
   ‚îú‚îÄ 93 marcados is_sold=true
   ‚îî‚îÄ 75 marcados is_sold=false
   
‚ùå PROBLEMA: Los ~10 RESERVADOS de duc_scraper
   NO est√°n sincronizados con stock
```

---

## ü§î SIGUIENTE PASO

Una vez entendido este PASO 1, el siguiente ser√≠a:

**PASO 2:** ¬øC√≥mo entra un veh√≠culo MANUALMENTE al sistema?
- Usuario crea entrada en `nuevas_entradas`
- ¬øQu√© datos se necesitan?
- ¬øQu√© pasa despu√©s?

¬øQuieres que analicemos el PASO 2 o prefieres que profundicemos m√°s en este PASO 1? üéØ


